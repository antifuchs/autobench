#!/bin/sh

. `dirname $0`/../functions

VERSION=$1; shift
LISP=$1; shift
BENCHLOG=${1:-/dev/stdout}; shift
RUNS=${1:-3}; shift
BENCHMARKS=$@


ARCHIVEDIR=$BASE/build-archive/$VERSION

case $LISP in
	sbcl)
		BINARY=$ARCHIVEDIR/sbcl
		CORE=$ARCHIVEDIR/sbcl.core
		SBCL=$BINARY
		SBCL_OPT="--core $CORE $COMMON_OPTS --boink-core-file $CORE"
		RUN=run-sbcl.sh
		export SBCL SBCL_OPT
		;;
	lisp)
		BINARY=$ARCHIVEDIR/lisp
		CORE=$ARCHIVEDIR/lisp.core
		CMUCL=$BINARY
		CMUCLOPT="-batch -core $CORE --boink-core-file $CORE"
		RUN=run-cmucl.sh
		export CMUCL CMUCLOPT
		;;
esac

if [ -f "$CORE".gz ] ; then
	gunzip -f $CORE.gz
fi
if [ -f "$BINARY".gz ] ; then
	gunzip -f $BINARY.gz
fi

cd $BASE/cl-bench

echo "($BENCHMARKS)" >benchmarks-to-run

i=0
while [ $i -lt $RUNS ]; do
	sh $RUN 2>>$BENCHLOG >&2
	i=$(($i+1))
done

gzip -f $BINARY
gzip -f $CORE

# arch-tag: "100c4290-ff31-11d8-8b1b-000c76244c24"
