#!/bin/sh -e

. `dirname $0`/../functions

DIR=$1; shift
TIMES=${1:-6}; shift
BENCHMARKS=$@

LISP=${LISP:-lisp}
HOST="$LISP $LISPFLAGS -batch"
export HOST

TTV=`tla tree-version $DIR`



cd $DIR

MVER=`sbcl-version`
ARCHIVEDIR=$BASE/build-archive/$MVER

REPORTLOG="$BASE/log.report/run-`date +%Y-%m-%d`"
UPDATELOG="$BASE/log.compile/update-`date +%Y-%m-%d`"
COMPILELOG="$BASE/log.compile/build-`date +%Y-%m-%d`-$MVER"
BENCHLOG="$BASE/log.benchmark/benchmark-`date +%Y-%m-%d`-$MVER"

add-version-to-db $UPDATELOG
if build-this-version $COMPILELOG; then

	run-benchmark-for $MVER sbcl $BENCHLOG $TIMES $BENCHMARKS

	cd $BASE

	add-results-to-db $REPORTLOG
	run-report $REPORTLOG

	echo "run completed for $MVER"
	rm -f $BENCHLOG 2>/dev/null
	rm -f $COMPILELOG 2>/dev/null
	rm -f $REPORTLOG 2>/dev/null
else
	echo "couldn't build $MVER"
	exit 1
fi


# arch-tag: "1006d602-ff31-11d8-8b1b-000c76244c24"
